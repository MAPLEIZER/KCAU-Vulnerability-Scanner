# Import necessary modules
from flask import Flask, request, redirect, render_template
import sqlite3

# Initialize the Flask application
app = Flask(__name__)

# Define a list of allowed IP addresses
allowed_ips = ['10.0.0.1', '192.168.0.1']

# Define a function to check if an IP address is allowed
def is_allowed_ip(ip_address):
    if ip_address in allowed_ips:
        return True
    else:
        return False

# Define a function to log incoming requests to a SQLite database
def log_request(ip_address, request_method, request_path):
    # Connect to the SQLite database
    conn = sqlite3.connect('request_log.db')
    c = conn.cursor()
    # Insert the IP address, request method, and request path into the log table
    c.execute('INSERT INTO log (ip_address, request_method, request_path) VALUES (?, ?, ?)', (ip_address, request_method, request_path))
    # Commit the changes and close the connection
    conn.commit()
    conn.close()

# Define a function to get the top 10 requested paths from the SQLite database
def get_top_paths():
    # Connect to the SQLite database
    conn = sqlite3.connect('request_log.db')
    c = conn.cursor()
    # Select the top 10 requested paths from the log table
    c.execute('SELECT request_path, COUNT(*) AS count FROM log GROUP BY request_path ORDER BY count DESC LIMIT 10')
    top_paths = c.fetchall()
    # Close the connection and return the top 10 requested paths
    conn.close()
    return top_paths

# Define a function to get the number of requests from a specific IP address
def get_requests_by_ip(ip_address):
    # Connect to the SQLite database
    conn = sqlite3.connect('request_log.db')
    c = conn.cursor()
    # Select the number of requests from the specified IP address
    c.execute('SELECT COUNT(*) FROM log WHERE ip_address = ?', (ip_address,))
    num_requests = c.fetchone()[0]
    # Close the connection and return the number of requests
    conn.close()
    return num_requests

# Define a function to get the IP addresses with the most requests
def get_top_ips():
    # Connect to the SQLite database
    conn = sqlite3.connect('request_log.db')
    c = conn.cursor()
    # Select the IP addresses with the most requests
    c.execute('SELECT ip_address, COUNT(*) AS count FROM log GROUP BY ip_address ORDER BY count DESC LIMIT 10')
    top_ips = c.fetchall()
    # Close the connection and return the top IP addresses
    conn.close()
    return top_ips

# Define the URL path for filtering and redirecting traffic
@app.route('/', methods=['GET', 'POST'])
def filter_and_redirect():
    # Get the user's IP address
    user_ip = request.remote_addr
    
    # Log the incoming request
    log_request(user_ip, request.method, request.path)
    
    # Check if the user's IP address is allowed
    if is_allowed_ip(user_ip):
        # If the user's IP address is allowed, redirect them to the target website
        return redirect('https://www.targetwebsite.com')
    else:
        # If the user's IP address is not allowed, return an error message
        return 'Access Denied'

# Define a route for viewing the top 10 requested paths
@app.route('/top-paths', methods=['GET'])
def view_top_paths():
    # Get the top 10 requested paths from the database
    top_paths = get_top_paths()
    # Render the top paths template with the top paths data
     
    return render_template('top-paths.html', top_paths=top_paths)

